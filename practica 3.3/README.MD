# Практика Spark

1. Для решения практической части по теме Spark вы можете воспользоваться:

    1. Возможностями сборки Cloudera quickstart для виртуальной машины – не самый рекомендуемый вариант, т.к. в классической сборке присутствует spark версии 1.2-1.6, которые можно считать устаревшими. Тем не менее, вы можете пойти данным путем и дополнительно обновить версию spark до 2+ в вашей ВМ.

    1. Установить Spark локально – рекомендуемый способ, т.к. установка spark локально не должна сильно нагрузить вашу ОС. Для помощи можно воспользоваться гайдом:

        * Part 1 - https://www.youtube.com/watch?v=XvbEADU0IPU

        * Part 2 - https://www.youtube.com/watch?v=e_QoFQjZwqc

    1. Установить Spark из образа Docker. Можно, например, воспользоваться ссылкой: https://github.com/cluster-apps-on-docker/spark-standalone-cluster-on-docker

1. Мы попробуем использовать возможности Spark для анализа данных clickstream пользователей новостного Интернет-портала.

    1. Создайте схему будущего фрейма данных. Схема должна включать следующие атрибуты:

        * id -  уникальный идентификатор посетителя сайта. Тип – последовательность чисел фиксированной длины. Данное поле не является первичным ключом.

        * timestamp – дата и время события в формате unix timestamp.

        * type – тип события, значение из списка (факт посещения(visit), клик по визуальному элементу страницы(click), скролл(scroll), перед на другую страницу(move)).

        * page_id – id текущей страницы. Тип - последовательность чисел фиксированной длины.

        * tag – каждая страница с новостью размечается редакцией специальными тегами, которые отражают тематику конкретной новости со страницы. Возможный список тематик: политика, спорт, медицина и т.д.

        * sign – наличие у пользователя личного кабинета. Значения – True/False.

    1. Создайте датафрейм с описанной выше схемой данных.

    1. Наполните датафрейм данными. Пример:

    (12345, 1667627426, "click", 101, "Sport”, False)

    1. Решите следующие задачи:

        1. Вывести топ-5 самых активных посетителей сайта

        1. Посчитать процент посетителей, у которых есть ЛК

        1. Вывести топ-5 страниц сайта по показателю общего кол-ва кликов на данной странице

        1. Добавьте столбец к фрейму данных со значением временного диапазона в рамках суток с размером окна – 4 часа(0-4, 4-8, 8-12 и т.д.)

        1. Выведите временной промежуток на основе предыдущего задания, в течение которого было больше всего активностей на сайте.

        1. Создайте второй фрейм данных, который будет содержать информацию о ЛК посетителя сайта со следующим списком атрибутов

            * Id – уникальный идентификатор личного кабинета

            * User_id – уникальный идентификатор посетителя

            * ФИО посетителя

            * Дату рождения посетителя 

            * Дата создания ЛК

        1. Вывести фамилии посетителей, которые читали хотя бы одну новость про спорт.

        1. *Выведите 10% ЛК, у которых максимальная разница между датой создания ЛК и датой последнего посещения.

        1. *Вывести топ-5 страниц, которые чаще всего посещают мужчины и топ-5 страниц, которые посещают чаще женщины.

        1. *Создайте в Postgres таблицы аналогичной структуры и выполните следующие задания с помощью Spark.

        1. *Создайте витрину данных в Postgres со следующим содержанием

            * Id посетителя

            * Возраст посетителя

            * Пол посетителя (постарайтесь описать логику вычисления пола в отдельной пользовательской функции)

            * Любимая тематика новостей

            * Любимый временной диапазон посещений

            * Id личного кабинета

            * Разница в днях между созданием ЛК и датой последнего посещения. (-1 если ЛК нет)

            * Общее кол-во посещений сайта

            * Средняя длина сессии(сессией считаем временной промежуток, который охватывает последовательность событий, которые происходили подряд с разницей не более 5 минут).

            * Среднее кол-во активностей в рамках одной сессии

        1. *Редакция совместно с аналитиками хотят провести масштабную рекламную кампанию, в рамках которой на сайте будут выпущены 3 новости с новой тематикой. Рекламный бюджет позволяет охватить только 10% доступной вам аудитории посетителей сайта. Напишите запрос, который позволит вычислить целевую аудиторию для данных новостей. Постарайтесь объяснить ваше решение. 

****
Выложите в git ваше решение. Достаточно только файла(ов) с кодом. Студенты, которые планируют решать задачи hard-когорты должны также приложить скрипты инициализации необходимых таблиц. 

[Решение](/practica%203.3/DE_Sprint.ipynb)